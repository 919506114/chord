@section Scripts {
    <script>

        //观察模型
        var model = {
            // 图书馆列表
            //librarys: ko.observableArray(),
            //selectedLib: ko.observable(""),
            // 界面输入值
            name: ko.observable(""),
            tel: ko.observable(""),

            // 界面用于绑定输入的password
            password: ko.observable(""),

            //tempLib: ko.observable("")
        }

        //用于获取图书馆
        function getAllLib() {
            //显示等待图层
            var index = loadLayer();

            // 先删除观察数组中的已有数据
            //model.librarys.removeAll();

            // 调web api
            var url = "/api/library";
            sendAjaxRequest(url, "GET", function (data) {

                var selLib = $("#selLib");
                var opt = "<option value=''>请选择 图书馆</option>";
                selLib.append(opt);
                for (var i = 0; i < data.length; i++) {
                    //遍历从服务器得到的结果，以push方法对该数组填充新数据
                    //model.librarys.push(data[i]);
                    var item=data[i];
                    opt = "<option value='" + item.libCode + '*' + item.libUserName + "'>" + item.libName + "</option>";
                    selLib.append(opt);
                }


                // 设上传进来的libcode
                var libCode = $("#spanLibCode").text();
                if (libCode != null && libCode != "") {
                    $("#selLib option[value='" + libCode + "']").attr("selected", "selected");
                }

                // 关闭等待层
                layer.close(index);

            }, function (xhq, textStatus, errorThrown) {

                alert(errorThrown);
                // 关闭等待层
                layer.close(index);
            });
        }


        //$(document).ready调用是jQuery推迟函数执行的一项标准技术，
        //它直到浏览器加载并处理了文档的所有HTML元素之后才会执行。
        $(document).ready(function () {

            //绑定观察模块
            ko.applyBindings(model);
            //获取图书馆列表
            getAllLib();






            var readerName = $("#spanReaderName").text();
            if (readerName != null && readerName != "")
            {
                model.name(readerName);
            }



            // 电话号码打回车时，进行找加密码
            $('#txtTel').bind('keypress', function (event) {
                if (event.keyCode == "13") {

                    // 要先给观察模型赋值一下,鼠标没离开输入框时，观察者模型还没有值
                    model.tel($('#txtTel').val());

                    resetPassword();
                }
            });

            // 密码框打回车时，进行绑定
            $('#password').bind('keypress', function (event) {
                if (event.keyCode == "13") {
                    // 要先给观察模型赋值一下,鼠标没离开输入框时，观察者模型还没有值
                    model.password($('#password').val());

                    //alert("bind");
                    bind();
                }
            });



        })

        //找回密码
        function resetPassword() {

            //alert("resetPassword");
            // 图书馆
            //var lib = model.selectedLib();
            var lib = $("#selLib").val();
            if (lib == "" || lib == null) {
                alert("您尚未选择图书馆。");
                return;
            }
            //alert(lib);
            var nIndex = lib.indexOf("*");
            var libCode = lib.substr(0, nIndex);
            var libUserName = lib.substr(nIndex + 1);
            //alert("libcode:["+libCode+"] libUserName:[" + libUserName+"]");

            var name = model.name();//$("#name").val();
            if (name == "") {
                alert("您尚未输入姓名。");
                return;
            }
            var tel = model.tel();//$("#tel").val();
            if (tel == "") {
                alert("您尚未输入手机号码。");
                return;
            }
            //alert(name + "-" + tel);

            //显示等待图层
            var index = loadLayer();

            // 调web api获取临时密码
            var url = "/api/wxuser?libUserName=" + libUserName + "&libCode=" + libCode + "&name=" + encodeURIComponent(name) + "&tel=" + tel;
            sendAjaxRequest(url, "POST", function (result) {
                // 关闭等待层
                layer.close(index);

                // 出错，或者由于条件限制未成功
                if (result.errorCode == -1 || result.errorCode == 0) {
                    //openMsg(result.errorInfo);
                    $("#warnText").html(result.errorInfo);
                    $("#warnText").css("color", "red");  //设置p元素的样式颜色为红色
                    return; //test
                }

                $("#warnText").html("密码已通过短信方式发送到手机 " + tel + ",您可以在下方密码框输入手机短信中的密码，立即绑定账号。");
                $("#warnText").css("color", "green");  //设置p元素的样式颜色为红色
                $("#divBind").css('display', 'block');

                // 将焦点移到密码输入框
                $("#password").focus();
                // 禁止掉找回密码按钮
                $("#btnResetPassword").attr({ "disabled": "disabled" });

                //清空输入框，注意这里没清除选择的图书馆
                // model.name("");
                //model.tel("");




            }, function (xhq, textStatus, errorThrown) {
                alert(errorThrown);
            });



        }

        // 绑定账号
        function bind() {
            // 图书馆
            //var lib = model.selectedLib();
            var lib = $("#selLib").val();
            if (lib == "" || lib == null) {
                alert("您尚未选择图书馆。");
                return;
            }
            //alert(lib);
            var nIndex = lib.indexOf("*");
            var libCode = lib.substr(0, nIndex);
            var libUserName = lib.substr(nIndex + 1);
            //alert("libcode:["+libCode+"] libUserName:[" + libUserName+"]");

            //姓名
            var word = model.name().trim();
            if (word == "") {
                alert("您尚未输入姓名。");
                return;
            }

            //密码
            var password = model.password().trim();
            if (password == "") {
                alert("您尚未输入密码。");
                return;
            }
            // 微信id
            var weixinId = $("#weixinId").text();
            if (weixinId == "") {
                alert("weixinId不能为空。");
                return;
            }

            //显示等待图层
            var index = loadLayer();
            var url = "/api/wxuser";
            sendAjaxRequest(url, "POST",
                function (result) {

                    // 关闭等待层
                    layer.close(index);

                    if (result.apiResult.errorCode == -1) {
                        alert(result.apiResult.errorInfo);
                        //openMsg(result.apiResult.errorInfo);
                        return;
                    }

                    //清空编辑界面信息,前两项可以不清除
                    //model.name("");
                    //model.password("");
                    
                    alert("绑定成功");
                    // 回到账户管理页面
                    var returnUrl = "/Home/Index";
                    var myUrl = getRootPath() + returnUrl;
                    //mui.openWindow({
                    //    url: myUrl,
                    //    id: 'info'
                    //});
                    window.location = myUrl;
                },
                function (xhq, textStatus, errorThrown) {
                    alert(errorThrown);
                    // 关闭等待层
                    layer.close(index);
                },
                {
                    weixinId: weixinId,
                    prefix: "NB",
                    word: word,
                    password: password,
                    libCode: libCode,
                    libUserName: libUserName
                }
            );
        }




    </script>
}

@section header {
        <h1 class="mui-title">找回密码</h1>
}
<span id="weixinId" style="display:none">@Session[dp2weixin.service.WeiXinConst.C_Session_WeiXinId]</span>
<span id="spanLibCode" style="display:none">@ViewBag.LibCode</span>
<span id="spanReaderName" style="display:none">@ViewBag.ReaderName</span>

    <div class="mui-input-group">
        <div class="mui-input-row ">
            <label style="color:#cccccc">图书馆</label>
            <select id="selLib" style="padding-left: 0px;width: 65%"></select>
        </div>
        <div class="mui-input-row ">
            <label style="color:#cccccc">姓名</label>
            <input type="text" class="mui-input mui-input-clear" placeholder="请输入 姓名" data-bind="value:model.name">
        </div>
        <div class="mui-input-row">
            <label style="color:#cccccc">手机号码</label>
            <input type="text" id="txtTel" class="mui-input mui-input-clear" placeholder="请输入 手机号码" data-bind="value:model.tel">
        </div>
    </div>

    <div class="mui-content-padded">
        <button id='btnResetPassword' class="mui-btn mui-btn-block mui-btn-primary" onclick="resetPassword()">找回密码</button>
        <span style="color:red" id="warnText"></span>
    </div>
    <div id="divBind" style="display:none">
        <div class="mui-input-group">
            <div class="mui-input-row">
                <label>密码</label>
                <input id="password" type="password" class="mui-input-password" placeholder="请输入 密码" data-bind="value:model.password">
            </div>
        </div>
        <div class="mui-content-padded">
            <button id='btnBind' class="mui-btn mui-btn-block mui-btn-primary" onclick="bind()">绑定账号</button>
        </div>
    </div>
