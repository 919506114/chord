@section style {
    <style>
        .title {
            /*上外边距是 10px 右外边距和左外边距是 5px 下外边距是 15px*/
            margin: 10px 15px 2px;
            color: #666666;
            font-size: 16px;
        }

        TABLE.libTable {
            text-align: left;
            background-color: white;
            width: 100%;
        }

            TABLE.libTable TR TD {
                border-width: 0px;
                /*border-top-width: 1px;
            border-color: #dddddd;
            border-style: dotted;*/
                padding: 2px;
            }

                TABLE.libTable TR TD.value {
                    border-left: 1px solid #CCCCCC;
                    padding-left: 5px;
                }

                TABLE.libTable TR TD.button {
                    padding-left: 5px;
                    text-align: right;
                }

                TABLE.libTable TR TD.label {
                    width: 80px;
                    background-color: #eeeeee;
                    color: #999999;
                    padding-left: 5px;
                    padding-right: 5px;
                    /*text-align: right;*/
                }

        .leftLabel {
            color: #999999;
        }

        .bb-title {
            line-height: 1;
            margin-top: 5px;
            margin-bottom: 5px;
            font-size: 20px;
        }
    </style>
}
@section Scripts {
    <script>
        var model = {
            list: ko.observableArray(),
            editor: {
                id: ko.observable(""),
                title: ko.observable(""),
                content: ko.observable(""),
                publishTime: ko.observable(""),
                creator:ko.observable("")
            },
            displaySummary: ko.observable(true)
        }

        //用于获取图书馆
        function getBbs() {
            var libId = $("#libId").text();//.val();
            //alert("["+libId+"]");
            // 先删除可观察数组中的已有数据
            model.list.removeAll();

            if (libId == "")
                return;

            //显示等待图层
            var index = loadLayer();



            // 调web api
            var url = "/api/Bb?libId=" + libId;
            sendAjaxRequest(url, "GET", function (result) {

                // 关闭等待层
                layer.close(index);

                if (result.errorCode == -1) {
                    alert(result.errorInfo);
                    return;
                }

                if (result.items == null || result.items.length == 0)
                    $("#divNo").css('display', 'block');
                else
                    $("#divNo").css('display', 'none');

                // 把返回的数组加到观察数组
                if (result.items != null) {
                    for (var i = 0; i < result.items.length; i++) {
                        model.list.push(result.items[i]);
                    }
                }

            }, function (xhq, textStatus, errorThrown) {

                alert(errorThrown);
                // 关闭等待层
                layer.close(index);
            });
        }

        // 删除一项
        function remove(item) {

            var gnl = confirm("你确定要删除公告[" + item.title + "]吗?");
            if (gnl == false) {
                return false;
            }

            var libId = $("#libId").text();
            if (libId == "") {
                alert("异常情况：libId为空。");
                return;
            }

            //alert("remove-"+item.libId);
            var url = "/api/Bb/" + item.id
                + "?libId=" + libId
            sendAjaxRequest(url, "DELETE", function () {
                //getAllLib();

                for (var i = 0; i < model.list().length; i++) {
                    if (model.list()[i].id == item.id) {
                        model.list.remove(model.list()[i]);
                        break;
                    }
                }

                // alert("length[" + model.list().length.length + "]");

                if (model.list().length == 0)
                    $("#divNo").css('display', 'block');
                else
                    $("#divNo").css('display', 'none');

            }, function (xhq, textStatus, errorThrown) {
                alert(errorThrown);
            });
        }

        // 新增一项
        function add() {

            var title = model.editor.title();
            if (title == "") {
                alert("请输入标题。");
                return;
            }
            var content = model.editor.content();
            if (content == "") {
                alert("请输入内容。");
                return;
            }

            var libId = $("#libId").text();
            if (libId == "") {
                alert("异常情况：libId为空。");
                return;
            }

            var creator = $("#creator").text();
            if (creator == "") {
                alert("异常情况：creator为空。");
                return;
            }
            

            //显示等待图层
            var index = loadLayer();

            var url = "/api/Bb?libId=" + libId;
            sendAjaxRequest(url, "POST",
                function (newItem) {

                    // 增加到观察数组里
                    //model.list.push(newItem);
                    getBbs();

                    model.displaySummary(true);

                    //清空编辑界面信息
                    model.editor.title("");
                    model.editor.content("");
                    model.editor.publishTime("");

                    // 关闭等待层
                    layer.close(index);
                },
                function (xhq, textStatus, errorThrown) {
                    alert(errorThrown);
                    // 关闭等待层
                    layer.close(index);
                },
                {
                    title: title,
                    content: content,
                    contentFormat: getContentFormat(),
                    creator:creator
                }
            );
        }

        // 新增一项
        function edit() {

            var title = model.editor.title();
            if (title == "") {
                alert("请输入标题。");
                return;
            }
            //alert(libCode);
            var content = model.editor.content();
            if (content == "") {
                alert("请输入内容。");
                return;
            }
            //alert(content);

            var libId = $("#libId").text();
            if (libId == "") {
                alert("异常情况：libId为空。");
                return;
            }

            var creator = $("#creator").text();
            if (creator == "") {
                alert("异常情况：creator为空。");
                return;
            }

            //显示等待图层
            var index = loadLayer();

            var id = model.editor.id();
            if (id == null || id == "") {
                alert("id参数为空，无法保存。");
                return;
            }
            var url = "/api/Bb?libId=" + libId;
            sendAjaxRequest(url, "PUT",
                function () {
                    //model.librarys.push(newItem);
                    model.displaySummary(true);
                    getBbs();

                    //清空编辑界面信息
                    model.editor.id("");
                    model.editor.title("");
                    model.editor.content("");
                    model.editor.publishTime("");
                    // 关闭等待层
                    layer.close(index);
                },
                function (xhq, textStatus, errorThrown) {
                    alert(errorThrown);
                    // 关闭等待层
                    layer.close(index);
                },
                {
                    id: id,
                    title: title,
                    content: content,
                    contentFormat: getContentFormat(),
                    creator: creator
                }
            );
        }

        function setShowTopButton() {

            if (browser.versions.iPhone == true) {
                $("input").focus(function () {
                    setShowValue(false);
                    window.setTimeout("showTopBottom()", 1);
                });
                $("input").blur(function () {
                    setShowValue(true);
                    window.setTimeout("showTopBottom()", 1);
                });

                //input[type=checkbox]不支持焦点事件


                $("textarea").focus(function () {
                    setShowValue(false);
                    window.setTimeout("showTopBottom()", 1);
                });
                $("textarea").blur(function () {
                    setShowValue(true);
                    window.setTimeout("showTopBottom()", 1);
                });
            }
        }

        // 点击新增图书馆按钮
        function handleCreateClick() {
            //alert("handleCreateClick1");
            model.displaySummary(false);
            //由于一进来没有显示编辑界面，所以这里要重新设一下
            setShowTopButton();
            //alert("handleCreateClick2");
            model.editor.id("");
            //alert("id-["+model.editor.id()+"]");

            //alert("handleCreateClick3");
            model.editor.title("");
            model.editor.content("");
            //alert("handleCreateClick4");
            model.editor.publishTime("");//publishTime
            model.editor.creator("");

            //alert("handleCreateClick5");
            $("#btnAdd").css('display', 'block');
            //alert("这里设为显示状态了");

            $("#btnEdit").css('display', 'none');
        }

        // 在新增图书馆，点击取消
        function handleCancelClick() {
            model.displaySummary(true);
        }

        function handleEditClick(item) {

            model.displaySummary(false);

            //由于一进来没有显示编辑界面，所以这里要重新设一下
            setShowTopButton();

            $("#btnAdd").css('display', 'none');
            $("#btnEdit").css('display', 'block');

            model.editor.id(item.id);
            //alert("id-["+model.editor.id()+"]");
            model.editor.title(item.title);
            model.editor.content(item.content);
            model.editor.publishTime(item.publishTime);//publishTime]
            model.editor.creator(item.creator);//publishTime

            if (item.contentFormat == "text") {
                $("input[name='cbMarkDown']").removeAttr("checked");//取消全选
            }
            else {
                $("input[name='cbMarkDown']").attr("checked", true);
            }
        }


        //$(document).ready调用是jQuery推迟函数执行的一项标准技术，
        //它直到浏览器加载并处理了文档的所有HTML元素之后才会执行。
        $(document).ready(function () {

            // 获取所有的操作命令
            getBbs();
            ko.applyBindings(model);

            // 设顶部菜单不固定
            $("#myheader").css("position", "absolute");
        })

        function getContentFormat() {
            var count = 0;
            $("input[name='cbMarkDown']:checked").each(function () {
                count++
            });

            if (count > 0)
                return "markdown";
            else
                return "text";
        }

        // 选择项改变
        function changeFormat() {

            var format = getContentFormat();
            if (format == "markdown") {
                setShowValue(false);
                window.setTimeout("showTopBottom()", 1);

                $("#divContent").css("background-color", "#FDF5E6");  //设为红色
            }
            else {
                setShowValue(true);
                window.setTimeout("showTopBottom()", 1);

                $("#divContent").css("background-color", "white");  //设为红色

            }
        }

    </script>
}
@section header {
    <h1 class="mui-title">公告管理</h1>
}
@if (ViewBag.RedirectInfo != null && ViewBag.RedirectInfo != "")
{
    @Html.Raw(ViewBag.RedirectInfo);
}
else
{
    <div class="mui-content-padded">
        <span>图书馆:</span><span>@ViewBag.LibName</span>
        <span id="libId" style="display:none">@ViewBag.LibId</span>
        <span id="creator" style="display:none">@ViewBag.Creator</span>        
    </div>

    <div data-bind="if: model.displaySummary">
        <div class="mui-content-padded">
            <button class="mui-btn mui-btn-block mui-btn-primary" data-bind="click: handleCreateClick">
                新发布公告
            </button>
        </div>
        <div class="mui-card" id="divNo" style="margin-top:10px;display:none">
            <center>
                <img src='../img/empty2.jpg' width='100' height='100' style=" padding-top:5px" />
                <div>目前没有公告。</div>
            </center>
        </div>

        <div data-bind=" foreach:model.list">
            <div class="mui-card" style="margin-top:10px">
                <div class="mui-content-padded">
                    <div class="bb-title" data-bind="text:title"></div>
                    <p style="color:gray;font-size:12px" >
                    <span data-bind="text:publishTime"></span>
                        <span data-bind="visible:creator!=''">-</span>
                        <span data-bind="text:creator"></span>
                    </p>
                    <div data-bind="html:contentHtml"></div>
                    <div style="text-align:right">
                        <button class="mui-btn  mui-btn-default" data-bind="click: handleEditClick">编辑</button>
                        <button class="mui-btn mui-btn-danger" data-bind="click: remove">X&nbsp;删除</button>
                    </div>
                </div>
            </div>
        </div>
        <br />
    </div>
    <div data-bind="ifnot: model.displaySummary">
        <div class="mui-card">
            <div class="mui-input-row" style="border-bottom:0px">
                <label class="leftLabel" style="width:20%;">标题</label>
                <input type="text" class="mui-input mui-input-clear" style='left:0px;width:80%' placeholder="请输入 标题" data-bind="value:model.editor.title">
            </div>
            <div class="mui-input-row" style="border-bottom:0px">
                <table>
                    <tr>
                        <td style="width:60px">
                            <label class="leftLabel" style="width:100%">内容</label>
                        </td>
                        <td>
                            <div class="mui-input-row mui-checkbox mui-left" style="border-bottom:0px;padding-bottom:0px;margin-bottom:0px;bottom:0px;float:left">
                                <label style='padding-left:30px;padding-right:0px'>MarkDown格式</label>
                                <input name="cbMarkDown" value="markdown" type="checkbox" style='left:0px;' onchange="changeFormat()">
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="mui-input-row" style="margin: 0px 15px;border-bottom:0px">
                <textarea rows="6" id="divContent" data-bind="value:model.editor.content"></textarea>
            </div>
            <div class="mui-input-row " style="">
                <label class="leftLabel">发布时间</label>
                <input type="text" class="mui-input mui-input-clear" disabled="disabled" data-bind="value:model.editor.publishTime">
            </div>
            <div class="mui-input-row " style="">
                <label class="leftLabel">工作人员</label>
                <input type="text" class="mui-input mui-input-clear" disabled="disabled" data-bind="value:model.editor.creator">
            </div>

            <div class="mui-content-padded">
                <table>
                    <tr>
                        <td style="padding-left:5px"><button class="mui-btn mui-btn-default" id="btnAdd" data-bind="click: add" style="display:none">发布</button></td>
                        <td style="padding-left:5px"><button class="mui-btn mui-btn-default" id="btnEdit" data-bind="click: edit" style="display:none">更新发布</button></td>
                        <td style="padding-left:5px"><button class="mui-btn mui-btn-default" data-bind="click:handleCancelClick">取消</button></td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
}
