@section Scripts {
    <script>

        //观察模型
        var model = {
            selectedLib: ko.observable(),
            reservations: ko.observableArray()    //预约列表
        }

        //2016-6-17 jane 获得当前绑定读者，为了解决普通浏览器返回时，读者信息没更新的问题,iphone倒是更新了
        function getActivePatron() {

            var weixinId = $("#weixinId").text();
            if (weixinId == "")
                return;

            //显示等待图层
            var index = loadLayer();

            // 调web api
            var url = "/api/wxuser?weixinId=" + weixinId + "&style=active";
            sendAjaxRequest(url, "GET", function (data) {

                // 关闭等待层
                layer.close(index);

                if (data == null)
                    return;

                //spanLibCode
                $("#spanLibCode").text(data.libCode + "*" + data.libUserName);
                //patronBarcode
                $("#patronBarcode").text(data.readerBarcode);
                //libUserName
                $("#libUserName").text(data.libUserName);

            }, function (xhq, textStatus, errorThrown) {

                alert(errorThrown);

                // 关闭等待层
                layer.close(index);
            });
        }

        //获取预约列表
        function getReservations(checkBarcode,obj,info,bWarn) {

            // 先删除可观察数组中的已有数据
            model.reservations.removeAll();                     

            var libUserName = $("#libUserName").text();
            if (libUserName == "") //未绑定
                return;

            var patronBarcode = $("#patronBarcode").text();

            //显示等待图层
            var index = loadLayer();

            // 调web api
            var url = "/api/Reservation?libUserName=" + encodeURIComponent(libUserName)
                + "&patronBarcode=" + encodeURIComponent(patronBarcode);
            sendAjaxRequest(url, "GET", function (result) {

                // 关闭等待层
                layer.close(index);

                // 出错或未命中
                if (result.errorCode == -1 || result.errorCode == 0) {
                    openMsg(result.errorInfo);
                    return;
                }

                for (var i = 0; i < result.reservations.length; i++) {
                    //加到观察数组中
                    model.reservations.push(result.reservations[i]);
                }

                if (checkBarcode != null && checkBarcode != "") {
                    var myhtml = getReservationHtml(checkBarcode)
                    $(obj)[0].innerHTML = myhtml;  // 不能直接设html
                    //$("#responsediv")[0].innerHTML = msg就可以获得这个Dom对象使用innerHTML。

                    var infoDiv = $(obj).parent().find(".resultInfo").first();
                    //alert(infoDiv);
                   // alert("["+info+"]");

                    $(infoDiv)[0].innerHTML=info;//.text(info);
                    if (bWarn==true)
                        $(infoDiv).css("background-color", "yellow");  //设为绿色
                    else
                        $(infoDiv).css("color", "darkgreen");  //设为绿色

                    //alert($(infoDiv).attr('id'));
                }

            }, function (xhq, textStatus, errorThrown) {

                alert(errorThrown);
                // 关闭等待层
                layer.close(index);
            });
        }

        function getReservationState(barcode)
        {
            //alert("getReservationState1");
            if (model.reservations().length == 0)
                return "未预约";

            //alert("getReservationState2");

            for (var i = 0; i < model.reservations().length; i++) {

                //alert("getReservationState3-"+i);
                var oneReservation = model.reservations()[i];
                var barcodeList = oneReservation.pureBarcodes;
                var arrivedBarcode = oneReservation.arrivedBarcode;
                var nIndex = barcodeList.indexOf(barcode);

                //alert(barcodeList + "-" + arrivedBarcode);
                if (nIndex>=0)
                {
                    if (barcode== arrivedBarcode)
                        return "已到书";
                    else
                        return "已预约";
                }                
            }

            return "未预约";
        }


        //$(document).ready调用是jQuery推迟函数执行的一项标准技术，
        //它直到浏览器加载并处理了文档的所有HTML元素之后才会执行。
        $(document).ready(function () {

            //alert("ready");
            //var isFirst1 = $("#isFirst1").val();
            //if (isFirst1 == "1") {
            //    $("#isFirst1").val("0");
            //    alert("isFirst1");
            //}

            // 为了记住上次选择的图书馆，不能这样使用，相关代码已删除
            //获取图书馆列表
            //getAllLib();

            //2016-6-17 jane 获得当前绑定读者，为了解决普通浏览器返回时，读者信息没更新的问题,iphone倒是更新了
            getActivePatron();

            // 获取预约列表
            getReservations();

            //绑定观察模块
            ko.applyBindings(model);

            // 密码框打回车时，进行绑定
            $('#txtWord').bind('keypress', function (event) {
                //alert("test");
                if (event.keyCode == "13") {
                    // 要先给观察模型赋值一下,鼠标没离开输入框时，观察者模型还没有值
                    search();
                }
            });

            // 设顶部菜单不固定
            $("#myheader").css("position", "absolute");

            // 当按浏览器返回按钮时，要显示原来的数据
            var word = $('#txtWord').val();
            if (word != "") {
                //alert("maxNo=" + $("#maxNo").val());
                var expandId = $('#expandId').val();
                search("_ReView", expandId);
            }
        });



        // 检索
        function search(bNext, expandId) {

            // 先删除more
            $("#more").remove();

            var libUserName = "";
            var from = "";
            var word = "";

            // 图书馆
            var lib = model.selectedLib();
            if (lib == "" || lib == null) {
                alert("您尚未选择图书馆。");
                return;
            }
            //alert(lib);
            var nIndex = lib.indexOf("*");
            var libCode = lib.substr(0, nIndex);
            var libUserName = lib.substr(nIndex + 1);

            if (bNext == 'true') {
                from = "_N";
                word = $("#maxNo").val();
            }
            else if (bNext == '_ReView') {
                from = "_ReView";
                word = $("#maxNo").val();
            }
            else {

                // 检查是否选择的检索途径
                from = $("#selFrom").val();
                if (from == "") {
                    alert("您尚未选择检索途径。");
                    return;
                }

                // 检查检索词
                word = $("#txtWord").val();
                if (word == "") {
                    alert("您尚未输入检索词。");
                    return;
                }
                //alert("[" + from + "]-[" + word + "]");

                var table = $("#ulResult");//$('.mui-table-view');
                table.html("");

            }

            //resultSet
            var resultSet = $("#resultSet").val();  //如果为空，服务器生成一个
            //if (resultSet == "")
            //{
            //    alert("异常情况：结果集值为空。");
            //    return;
            //}


            // 调检索接口
            //显示等待图层
            var index = loadLayer();

            // 调web api
            var url = "/api/biblio?libUserName=" + encodeURIComponent(libUserName)
                + "&from=" + encodeURIComponent(from)
                + "&word=" + encodeURIComponent(word)
                + "&resultSet=" + encodeURIComponent(resultSet);
            sendAjaxRequest(url, "GET",
                function (result) {

                    // 关闭等待层
                    layer.close(index);

                    //alert("2");
                    if (result.apiResult.errorCode == -1) {
                        $("#searchInfo").text("检索出错:" + result.apiResult.errorInfo);
                        $("#searchInfo").css("color", "red");  //设置p元素的样式颜色为红色
                    }
                    else if (result.apiResult.errorCode == 0) {
                        $("#searchInfo").text("未命中");
                        $("#searchInfo").css("color", "red");  //设置p元素的样式颜色为红色
                    }
                    else {
                        $("#searchInfo").text("命中" + result.apiResult.errorCode + "条记录。");
                        $("#searchInfo").css("color", "darkgreen");  //设置p元素的样式颜色为红色
                    }

                    // 出错或未命中
                    if (result.apiResult.errorCode == -1 || result.apiResult.errorCode == 0) {
                        openMsg(result.apiResult.errorInfo);
                        return;
                    }

                    //alert("1");

                    var table = $("#ulResult");//$('.mui-table-view');
                    var start = 0;
                    if (bNext == 'true') {
                        start =parseInt($("#maxNo").val());
                    }
                    for (var i = 0; i < result.records.length; i++) {
                        var record = result.records[i];
                        var id="record-"+(start+i);
                        var li = "<li class='mui-table-view-cell mui-collapse' id='" + id + "'> "
                            + "<a class='mui-navigate-right'  href='javascript:void(0)' onclick='expand(\""+id+"\")'>" + record.no + " " + record.name + "</a>"
                            + "<div class='mui-collapse-content' style='display:none;'>"
                                + "<span class='pendingDetail' >"
                                    + "<label>"+record.libUserName+"|"+record.recPath+"</label>"
                                    + "<img src='../img/wait2.gif' />"
                                + "</span>"
                            + "</div>"
                            + "</li>";
                        table.append(li);

                        if (i == result.records.length - 1) {
                            $("#maxNo").val(record.no);
                            $("#resultSet").val(result.resultSetName);
                        }
                    }

                    //<li class="mui-table-view-cell mui-collapse">
                    //<a class="mui-navigate-right" href="#">表单</a>
                    //<div class="mui-collapse-content">



                    //有下页的情况
                    if (result.isCanNext == true) {
                        var li1 = "<li class='mui-table-view-cell'  id='more'>"
                            + "<center><a href='javascript:void(0)' onclick='searchN()'>点击加载更多</a></center>"
                            + "</li>";
                        table.append(li1);
                    }

                    // 打开需要展开的项
                    if (expandId != null && expandId != "")
                    {
                        expand(expandId);
                    }

                    // 关闭等待层
                    //layer.close(index);

                }, function (xhq, textStatus, errorThrown) {

                    alert(errorThrown);
                    // 关闭等待层
                    layer.close(index);
                });
        }



        //预约
        function reservation(obj, barcode, style) {
            //alert($("input[name='ckbBarcode']:checked").length);
            if (style == "delete") {
                var opeName = $(obj).text();
                var gnl = confirm("你确定对册[" + barcode + "]" + opeName + "吗?");
                if (gnl == false) {
                    return false;
                }
            }


            var selLib = model.selectedLib();
            var myLib = $("#spanLibCode").text();
            if (selLib != myLib) //应该不会走到这里，因为当前选择的图书馆不是绑定对应的图书馆的时候，不会走到这里
            {
                alert("您绑定的图书馆与选择的图书馆不一致");
                return;
            }
            //alert(lib);
            var nIndex = myLib.indexOf("*");
            var libCode = myLib.substr(0, nIndex);
            var libUserName = myLib.substr(nIndex + 1);


            var patron = $("#patronBarcode").text();
            if (patron == "")
            {
                alert("您尚未绑定图书馆账户，请先绑定账户。");
                return;
            }

            var items = barcode;//"";
            //$("input[name='ckbBarcode']:checked").each(function () {                
            //    if (items != "")
            //        items += ",";
            //    items += $(this).val();
            //});
            if (items == "") {
                alert("您尚未选择要预约的册记录。");
                return;
            }
            //alert(items);

            //显示等待图层
            var index = loadLayer();

            var url = "/api/Reservation?libUserName=" + encodeURIComponent(libUserName)
                + "&patron=" + encodeURIComponent(patron)
                + "&items=" + encodeURIComponent(items)
                + "&style=" + style;//new 创建一个预约请求,delete删除
            // 调api
            sendAjaxRequest(url, "POST", function (result) {


                // 关闭等待层
                layer.close(index);

                // 显示预约结果
                var infoDiv = $(obj).parent().parent().parent().find(".resultInfo").first();
                //alert(infoDiv);
                var info = result.errorInfo;

                $("input[name='ckbBarcode']").removeAttr("checked");//取消全选 

                // 出错
                if (result.errorCode == -1) {
                    $(infoDiv).text(info);
                    $(infoDiv).css("color", "red");  //设为红色

                    alert(result.errorInfo);
                    return;
                }

                var bWarn = true;
                if (info == "") {
                    info = $(obj).html() + " 操作成功。";
                    bWarn = false;
                }
                else {
                    info = $(obj).html() + " 操作成功。<br>"+info;
                }

                alert(info.replace("<br>","\r\n"));

                // 更新列表
                var div = $(obj).parent().parent();
                getReservations(barcode, div, info, bWarn);


            }, function (xhq, textStatus, errorThrown) {

                // 关闭等待层
                layer.close(index);

                // 显示预约结果
                var infoDiv = $(obj).parent().parent().parent().find(".resultInfo").first();
                var info = "访问服务器出错：[" + errorThrown + "]";
                alert(info);

                $(infoDiv).text(info);
                $(infoDiv).css("color", "red");  //设为红色                
            });
        }

        // 2016-6-17 jane 为了返回时记住展开项，expand函数由原来传一个对象，改为传一个id 
        function expand(expId)
        {
            // 如果自己是展开状态，则收缩
            var id = "#" + expId;
            var obj = $(id);
            //obj = $(obj).parent();
            var  state=$(obj).find(".mui-collapse-content").first().css("display");
            if (state == "block") { //自己本来是展开状态，要关闭   
                    $(obj).find(".mui-collapse-content").css("display", "none");
                    $(obj).removeClass("mui-active");
            }
            else {
                //其它收缩
                $(".mui-collapse-content").css("display", "none");
                $(".mui-collapse").removeClass("mui-active");

                //自己展开
                $(obj).find(".mui-collapse-content").css("display", "block");
                $(obj).addClass("mui-active");

                // 记住展开项
                $("#expandId").val(expId);


                //检查是否已经加载过了
                var o = $(obj).find(".pendingDetail:first");
                if (o.length == 0) {
                    return;
                }
                else {
                    getDetail(o);
                }
            }
        }

        function getReservationHtml(barcode)
        {
            myReserHtml = "";
            var reservationState = getReservationState(barcode);
            //alert("[" + reservationState + "]");
            var btn = "";
            if (reservationState == "未预约") {
                btn = "<button class='mui-btn  mui-btn-default'  onclick=\"reservation(this,'" + barcode + "','new')\">预约该册</button>";
            }
            else if (reservationState == "已预约") {
                btn = "<button class='mui-btn  mui-btn-default'  onclick=\"reservation(this,'" + barcode + "','delete')\">取消预约</button>";
            }
            else if (reservationState == "已到书") {
                btn = "<button class='mui-btn  mui-btn-default'  onclick=\"reservation(this,'" + barcode + "','delete')\">放弃取书</button>";
            }
            if (reservationState != "") {
                myReserHtml = "<span style='vertical-align:middle;font-weight:bold''>" + reservationState + "&nbsp;&nbsp;</span><span style='vertical-align:middle'>" + btn + "</span>";
            }
            return myReserHtml;
        }



        function getDetail(o) {
            // 找到下级的标签，里面存储的线索
            var mylable = o.children("label");

            // pendingDetail没有定义标签label,去掉pendingDetail状态
            if (mylable.length == 0) {
                o.html("没找到存放线索信息的lable标签");
                o.removeClass("pendingDetail");
                return;
            }

            // 取出label设置的线索信息
            var keyword = mylable.text();
            // 未给label设值，去掉pendingDetail状态
            if (keyword.length == 0) {
                o.html("线索信息为空");
                o.removeClass("pendingDetail");
                return;
            }

            // 取出图书馆账号与记录路径
            var nIndex = keyword.indexOf('|');
            var libUserName = keyword.substring(0, nIndex);
            var biblioPath = keyword.substring(nIndex + 1);
            //alert("type[" + mytype + "]-value[" + myvalue + "]");
            if (libUserName == "" || biblioPath == "") {
                o.html("记录路径值[" + keyword + "]不对，格式应该为[图书馆账号|记录路径]");
                o.removeClass("pendingDetail");
                return;
            }

            // 调api
            var url = "/api/biblio?libUserName=" + encodeURIComponent(libUserName) + "&biblioPath=" + encodeURIComponent(biblioPath);
            sendAjaxRequest(url, "GET", function (result) {

                // 出错或未命中
                if (result.errorCode == -1 || result.errorCode == 0) {
                    o.html(result.errorInfo);
                    $(o).css("color", "red");  //设置p元素的样式颜色为红色
                    o.removeClass("pendingDetail");
                    return;
                }

                var itemTables = "";
                if (result.itemList.length == 0)
                    itemTables = "<div  class='mui-card' style='padding:0px;margin:0px;margin-top:3px'><center><img src='../img/empty3.png' width='50' height='50' style='padding-top:3px' /><div style='color:#999999'>该书没有下级册信息。</div><center></div>"

                var selLib = model.selectedLib();
                var myLib = $("#spanLibCode").text();
                var bCanReservation = false;
                var returnUrl = "/Biblio/Index";
                var info = "<span style='color:#999999;font-weight:normal'>您尚未绑定当前选择图书馆的读者账号，所以看不到预约信息，点击<a href='javascript:void(0)' onclick='gotoUrl(\"/Account/Bind?returnUrl=" + encodeURIComponent(returnUrl) + "\")'>这里</a>绑定读者帐号。</span>"
                if (myLib != "" && selLib == myLib) 
                {
                    bCanReservation = true;
                    info = "";
                }
                //alert(info);

                for (var i = 0; i < result.itemList.length; i++) {
                    var record = result.itemList[i];
                    var myReserHtml = info;
                    if (bCanReservation == true)
                        myReserHtml = "<div>"+getReservationHtml(record.barcode) + "</div><div class='resultInfo'></div>";


                    itemTables += "<table class='itemTable'>"
                    +"<tr>"
                    + "<td class='label'>册条码号"
                    +"</td>"
                    +    "<td class='value'>" + record.barcode + "</td>"
                    +"</tr>"
                    +"<tr>"
                    + "<td class='label'>状态</td>"
                    + "<td class='value'>" + record.state + "</td>"
                    + "</tr>"
                    + "<tr>"
                    + "<td class='label'>卷册</td>"
                    + "<td class='value'>" + record.volumn + "</td>"
                    + "</tr>"
                    + "<tr>"
                    + "<td class='label'>馆藏地</td>"
                    + "<td class='value'>" + record.location + "</td>"
                    + "</tr>"
                    + "<tr>"
                    + "<td class='label'>价格</td>"
                    + "<td class='value'>" + record.price + "</td>"
                    + "</tr>"
                    + "<tr>"
                    + "<td class='label'>在借情况</td>"
                    + "<td class='value'>" + record.borrowInfo + "</td>"
                    + "</tr>"
                    + "<tr>"
                    + "<td class='label'>预约信息</td>"
                    + "<td class='reservation' >" + myReserHtml + "</td>"
                    + "</tr>"
                    //
                    + "</table>";
                }

                var myHtml = "<span>" + result.summary + "</span>" + itemTables;


                //换成实际的值，去掉pendingDetail状态，
                o.html(myHtml);
                o.removeClass("pendingDetail");
            }, function (xhq, textStatus, errorThrown) {
                //出错，去掉pendingDetail状态
                o.html("访问服务器出错：[" + errorThrown+"]");
                o.removeClass("pendingDetail");
            });

            return;
        }


        //必须要换一个名称，被下一页使用，直接用search("true")不行
        function searchN() {
            search("true");
        }


    </script>
}

@section style {
<style type="text/css">

        TABLE.itemTable {
            text-align: left;            
            background-color: white;
            width: 100%;
       margin-top:10px;
        }

    TABLE.itemTable TR TD {
        border-width: 0px;
        border-top-width: 1px;
        border-color: #dddddd;
        border-style: dotted;
        padding: 2px;
    }

        TABLE.itemTable TR TD.value {
            /*border-left-width: 2px;*/
            border-left:1px solid #dddddd;
            padding-left:4px;
        }

        TABLE.itemTable TR TD.reservation {
            font-weight:normal; /*bolder;*/
                        border-left:1px solid #dddddd;
                        padding-left:4px;
        }

        TABLE.itemTable TR TD.label {
           width:80px;
           background-color:#ffffff;
           color:#999999;
           padding-left:4px;
        }
        
        .resultInfo {
            /*显示预约结果的span*/
        }
    </style>
}

@section header {
    <h1 class="mui-title">书目查询</h1>
    }
<span id="weixinId" style="display:none;">@Session[dp2weixin.service.WeiXinConst.C_Session_WeiXinId]</span>
<span id="spanLibCode" style="display:none">@ViewBag.LibCode</span>
<span id="patronBarcode" style="display:none">@ViewBag.PatronBarcode</span>
<span id="libUserName" style="display:none">@ViewBag.LibUserName</span>
<input id="maxNo" type="hidden" >
<input id="resultSet" type="hidden" value="" disabled="disabled">
<input id="expandId" type="hidden" value="" disabled="disabled">

    <div id="divForm">
        <div class="mui-input-group">
            <div class="mui-input-row ">
                <label style="color:#cccccc;">图书馆</label>
                @Html.Raw(ViewBag.LibHtml)
                <!--
                <select id="selLib" style="padding-left: 0px;width: 65%" data-bind="options:librarys,optionsText:function(item) {
                       return  item.libName; },optionsValue:function(item) {
                       return item.libCode + '*' + item.libUserName; },optionsCaption:'请选择 图书馆',value:selectedLib"></select>
                -->
            </div>

            <div class="mui-input-row ">
                <label style="color:#cccccc">检索途径</label>
                <select id="selFrom" name="selFrom">
                    <option value="title" selected>书名</option>
                    <option value="ISBN">ISBN</option>
                    <option value="contributor">作者</option>
                </select>
            </div>
            <div class="mui-input-row">
                <label style="color:#cccccc">检索词</label>
                <input id="txtWord" type="text" class="mui-input mui-input-clear" placeholder="请输入 检索词">
            </div>
        </div>

        <div class="mui-content-padded">
            <button id='login' class="mui-btn mui-btn-block mui-btn-primary" onclick="search('')">检索</button>


        </div>
    </div>

    <div id="divResult">
        <!--数据列表-->
        <span style="padding-left:10px" id="searchInfo"></span>
        <ul id="ulResult" class="mui-table-view "></ul>


    </div>
